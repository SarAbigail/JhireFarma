<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ventas</title>
  <link rel="stylesheet" th:href="@{/css/style.css}">
  <link href=" https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"></script>
</head>

<body>
  <div th:replace="fragments/sidebar::hamburgerBtnMobile"></div>
  <div class="container-fluid">
    <div class="row">
      <div th:replace="fragments/sidebar::sidebarMenuDesktop"></div>
      <div th:replace="fragments/sidebar::sidebarMenuMobile"></div>
      <!-- Contenido principal -->
      <main class="col-md-9 col-lg-10 bg-light-custom">
        <div class="row p-4 rounded">
          <!-- <h1>Ventas</h1> -->
          <!-- Detalle operación -->
          <div class="col-12 col-lg-8 mb-4 pe-lg-5">
            <h2>Productos</h2>
            <form class="d-flex mb-3" role="search">
              <input class="form-control" type="search" placeholder="Busca un producto" id="buscador"
                aria-label="Search" />
              <!-- <button class="btn btn-accent" type="submit">Buscar</button> -->
            </form>
            <div class="mb-3">
              <h2>Resultados</h2>
              <div class="bg-white p-3 table-responsive rounded" style="min-height: 50px;max-height: 200px;">
                <table class="table">
                  <thead>
                    <tr class="text-center">
                      <th>
                        ID
                      </th>
                      <th>
                        Descripción
                      </th>
                      <th>
                        Presentación
                      </th>
                      <th>
                        Stock
                      </th>
                      <th>
                        P.Venta
                      </th>
                      <th>
                        Acción
                      </th>
                    </tr>
                  </thead>
                  <tbody id="tabla-productos"></tbody>
                </table>
              </div>
            </div>
            <div class="mb-5">
              <h2>Detalle de la orden</h2>
              <div class="bg-white p-3 table-responsive rounded" style="min-height: 50px; max-height: 200px;">
                <table class="table" id="tablaOrden">
                  <thead>
                    <tr>
                      <th scope="col">#</th>
                      <th scope="col">Descripción</th>
                      <th scope="col">Presentación</th>
                      <th scope="col">Cantidad</th>
                      <th scope="col">Precio</th>
                      <th scope="col">Total</th>
                      <th scope="col">Acción</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

            </div>
            <!-- Botones de acción compra -->
            <div class="col-12 d-flex justify-content-evenly" role="group" aria-label="Basic example">
              <button type="button" class="col-4 btn btn-accent-ligth shadow-sm" onclick="reiniciarVenta()">Reiniciar
                venta &nbsp;<i class="bi bi-arrow-counterclockwise"></i></button>
              <button type="button" class="col-4 btn btn-main-lightest shadow-sm" onclick="registrarVenta()">Registrar
                venta &nbsp;<i class="bi bi-floppy-fill"></i></button>
            </div>
          </div>
          <!-- Preview Boleta -->
          <div class="col-12 col-lg-4">
            <h2>Boleta de venta</h2>
            <div class="border-success mb-3">
              <div class="bg-main-4 p-3 rounded mb-3">
                <h5 class="text-center m-0 text-white">S/ <span class="monto-total-boleta">0.00</span></h5>
              </div>
              <div class="bg-white rounded p-4 d-flex flex-column">
                <div class="row col-12 align-self-center mb-2">
                  <div class="col-4 ps-0">
                    <label for="input-serie" class="fw-bold">Serie</label>
                    <input type="text" name="input-serie" id="" class="form-control-ligth rounded w-100">
                  </div>
                  <div class="col-8 pe-0">
                    <label for="input-nro" class="fw-bold">Nro</label>
                    <input type=" text" name="input-nro" id="" class="form-control-ligth rounded w-100">
                  </div>
                </div>
                <div class="row col-12 align-self-center mb-2">
                  <label for="input-cliente" class="fw-bold p-0">Cliente</label>
                  <input type="text" name="input-cliente" id="" class="form-control-ligth rounded w-100">
                </div>
                <div class="row col-12 align-self-center mb-2">
                  <label for="input-dni" class="fw-bold p-0">DNI</label>
                  <input type="text" name="input-dni" id="" class="form-control-ligth rounded w-100" maxlength="8"
                    pattern="[0-9]{8}" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>
                <div class="row col-12 align-self-center mb-2">
                  <label for="input-fecha-emision" class="fw-bold p-0">Fecha de Emisión</label>
                  <input type="date" name="input-fecha-emision" id="fechaEmision"
                    class="form-control-ligth rounded w-100" disabled>
                </div>
                <hr>
                <p class=""><span class="fw-bold">Subtotal:</span> 0.00</p>
                <p class=""><span class="fw-bold">IGV:</span> 0.00</p>
                <p><span class="fw-bold">Total:</span> S/ <span class="monto-total-boleta">0.00</span></p>
                <div class="row col-12 align-self-center mb-2">
                  <label for="input-efectivo" class="fw-bold p-0">Efectivo</label>
                  <input type="text" name="input-efectivo" id="efectivo" class="form-control-ligth rounded w-100">
                </div>
                <p><span class="fw-bold">Vuelto: </span>S/ <span id="vuelto">0.00</span></p>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>
  <!-- Modal de Confirmación -->
  <div class="modal fade" id="ventaModal" tabindex="-1" aria-labelledby="ventaModalLabel" data-bs-backdrop="static"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center">
          <i class="bi bi-bag-check-fill icon-venta-success"></i>
          <p>Venta realizada con éxito</p>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-primary mx-auto mb-5 btn-main-lightest" data-bs-dismiss="modal">Imprimir
            comprobante</button>
          <p class="">* No olvide entregar productos y vuelto</p>
        </div>
      </div>
    </div>
  </div>
</body>

</html>

<script>
  //Para setear la fecha de emisión en hoy
  document.getElementById("fechaEmision").valueAsDate = new Date();

  //Carga de productos
  async function cargarProductos(filtro = "") {
    let url = "/api/productos";
    if (filtro) {
      url += "?buscar=" + encodeURIComponent(filtro);
    }
    const response = await fetch(url);
    const productos = await response.json();
    const tbody = document.getElementById("tabla-productos");
    tbody.innerHTML = "";
    productos.forEach(p => {
      const fila = document.createElement("tr");

      fila.innerHTML = `<tr class="text-center">
                      <td>${p.id}</td>
                      <td>${p.nombre}</td>
                      <td>${p.presentacion}</td>
                      <td>-</td>
                      <td>${p.precio}</td>
                      <td class="text-center"><button class="btn btn-accent-ligth fw-bold py-0" data-id="${p.id}"><i class="bi bi-plus"></i></button>
                      </td>
                    </tr>`;
      fila.querySelector("button").addEventListener("click", () => agregarAOrden(p));
      tbody.appendChild(fila);
    });
  }
  document.getElementById("buscador").addEventListener("input", (e) => {
    cargarProductos(e.target.value);
  });

  //Carga de productos inicial
  cargarProductos();

  //AGREGAR PRODUCTOS
  const buscador = document.getElementById("buscador");
  const tablaResultados = document.querySelector("#tablaResultados tbody");
  const tablaOrden = document.querySelector("#tablaOrden tbody");

  let orden = [];

  // Función para agregar producto a la orden
  function agregarAOrden(producto) {
    // Revisar si ya está en la orden
    let existente = orden.find(p => p.id === producto.id);
    if (existente) {
      existente.cantidad++;
    } else {
      orden.push({ ...producto, cantidad: 1 });
    }
    renderOrden();
  }

  // Función para mostrar la orden de compra
  function renderOrden() {
    const tbody = document.querySelector("#tablaOrden tbody");
    const montoTotal = document.querySelector(".monto-total-boleta");
    tbody.innerHTML = "";
    let totalGeneral = 0;

    orden.forEach((p, index) => {
      // Para que haya una cantidad mínima y precio numérico
      if (!p.cantidad || p.cantidad < 1) p.cantidad = 1;
      p.precio = Number(p.precio) || 0;

      const totalLinea = p.precio * p.cantidad;
      totalGeneral += totalLinea;

      const fila = document.createElement("tr");
      fila.innerHTML = `
      <td>${index + 1}</td>
      <td>${p.nombre}</td>
      <td>${p.presentacion}</td>
      <td>
        <input type="number" min="1" value="${p.cantidad}" data-index="${index}" class="cantidad-input form-control-ligth rounded w-100">
      </td>
      <td>${p.precio.toFixed(2)}</td>
      <td class="total-linea">${totalLinea.toFixed(2)}</td>
      <td class="text-center">
        <button type="button" class="btn btn-danger btn-eliminar" data-index="${index}"><i class="bi bi-trash-fill"></i></button>
      </td>
    `;
      tbody.appendChild(fila);
    });

    // Agregar fila de total despues de tabla
    const filaTotal = document.createElement("tr");
    filaTotal.innerHTML = `<td colspan="6" style="text-align:right"><strong>Total:</strong></td>
                           <td><strong>${totalGeneral.toFixed(2)}</strong></td>
                           <td></td>`;
    tbody.appendChild(filaTotal);

    // Actualizar todos los elementos con clase "monto-total-boleta"
    document.querySelectorAll(".monto-total-boleta").forEach(el => {
      el.textContent = totalGeneral.toFixed(2);
    });

    // Agregar listeners después de renderizar
    tbody.querySelectorAll(".cantidad-input").forEach(input => {
      input.addEventListener("change", (e) => {
        const idx = parseInt(e.target.dataset.index, 10);
        let val = parseInt(e.target.value, 10);
        if (isNaN(val) || val < 1) val = 1;
        orden[idx].cantidad = val;
        renderOrden();
      });
    });

    tbody.querySelectorAll(".btn-eliminar").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const idx = parseInt(e.currentTarget.dataset.index, 10);
        orden.splice(idx, 1);
        renderOrden();
      });
    });
  }

  //Funcion para boton reiniciar venta
  function reiniciarVenta() {
    // orden = [];
    // renderOrden();
    location.reload();
  }

  //Funcion para calcular vuelto
  function calcularVuelto() {
    const efectivoInput = document.querySelector("#efectivo");
    const vueltoEl = document.querySelector("#vuelto");
    // Leer efectivo ingresado
    const efectivo = parseFloat(efectivoInput.value) || 0;
    let total = 0;
    document.querySelectorAll(".monto-total-boleta").forEach(el => {
      total = parseFloat(el.textContent) || 0;
    });

    const vuelto = efectivo - total;
    vueltoEl.textContent = vuelto.toFixed(2);
  }

  // Ejecutar funcion calcular vuelto
  document.querySelector("#efectivo").addEventListener("input", calcularVuelto);

  //REGISTRO DE VENTAS
  let ventas = [];

  function registrarVenta() {
    if (orden.length === 0) {
      alert("El carrito está vacío. Agrega productos antes de registrar la venta.");
      return;
    }

    // Captura datos
    const fecha = document.getElementById("fechaEmision").value;
    const efectivo = parseFloat(document.getElementById("efectivo").value) || 0;

    // Calcula total actual
    let total = 0;
    orden.forEach(p => total += p.precio * p.cantidad);
    const vuelto = efectivo - total;

    // Objeto de venta
    const venta = {
      id: ventas.length + 1,
      fecha: fecha,
      productos: [...orden],
      total: total,
      efectivo: efectivo,
      vuelto: vuelto
    };

    // Guardar en venta
    ventas.push(venta);

    console.log("Venta registrada:", venta);
    console.log("Todas las ventas:", ventas);

    // Mostrar modal
    let modal = new bootstrap.Modal(document.getElementById('ventaModal'));
    modal.show();

    // Limpiar carrito
    orden = [];
    renderOrden();
    document.getElementById("efectivo").value = "";
    document.getElementById("vuelto").textContent = "0.00";
  }
</script>