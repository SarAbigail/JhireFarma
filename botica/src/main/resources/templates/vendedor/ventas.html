<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ventas</title>
  <link rel="stylesheet" th:href="@{/css/style.css}">
  <link href=" https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"></script>
</head>
<style>
  /* @media print {
    body * {
      visibility: hidden;
    }

    #comprobante,
    #comprobante * {
      visibility: visible;
    }

    #comprobante {
      position: absolute;
      left: 0;
      top: 0;
    }
  } */
  /* ————— SOLO IMPRIMIR EL COMPROBANTE ————— */
  @media print {
    body * {
      visibility: hidden;
      /* Oculta todo */
    }

    #comprobante,
    #comprobante * {
      visibility: visible;
      /* Muestra solo el comprobante */
    }

    #comprobante {
      position: absolute;
      top: 0;
      left: 0;
      width: 80mm;
      /* Formato ticket */
      padding: 10px;
      background: white;
    }
  }

  /* Estilo básico para que el comprobante se vea más bonito */
  #comprobante {
    font-family: Arial;
    font-size: 14px;
    line-height: 1.3;
  }

  #comprobante table th,
  #comprobante table td {
    padding: 3px 0;
  }
</style>

<body>
  <div th:replace="fragments/sidebar_pos::hamburgerBtnMobile"></div>
  <div class="container-fluid">
    <div class="row">
      <div th:replace="fragments/sidebar_pos::sidebarMenuDesktop"></div>
      <div th:replace="fragments/sidebar_pos::sidebarMenuMobile"></div>
      <!-- Contenido principal -->
      <main class="col-md-9 col-lg-10 bg-light-custom">
        <div class="row p-4 rounded">
          <!-- <h1>Ventas</h1> -->
          <!-- Detalle operación -->
          <div class="col-12 col-lg-8 mb-4 pe-lg-5">
            <h2>Productos</h2>
            <form class="d-flex mb-3" role="search">
              <input class="form-control" type="search" placeholder="Busca un producto" id="buscador"
                aria-label="Search" />
              <!-- <button class="btn btn-accent" type="submit">Buscar</button> -->
            </form>
            <div class="mb-3">
              <h2>Resultados</h2>
              <div class="bg-white p-3 table-responsive rounded" style="min-height: 50px;max-height: 200px;">
                <table class="table">
                  <thead>
                    <tr class="text-center">
                      <th>
                        ID
                      </th>
                      <th>
                        Descripción
                      </th>
                      <th>
                        Presentación
                      </th>
                      <th>
                        Stock
                      </th>
                      <th>
                        P.Venta
                      </th>
                      <th>
                        Acción
                      </th>
                    </tr>
                  </thead>
                  <tbody id="tabla-productos"></tbody>
                </table>
              </div>
            </div>
            <div class="mb-5">
              <h2>Detalle de la orden</h2>
              <div class="bg-white p-3 table-responsive rounded" style="min-height: 50px; max-height: 200px;">
                <table class="table" id="tablaOrden">
                  <thead>
                    <tr>
                      <th scope="col">#</th>
                      <th scope="col">Descripción</th>
                      <th scope="col">Presentación</th>
                      <th scope="col">Cantidad</th>
                      <th scope="col">Precio</th>
                      <th scope="col">Total</th>
                      <th scope="col">Acción</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>

            </div>
            <!-- Botones de acción compra -->
            <div class="col-12 d-flex justify-content-evenly" role="group" aria-label="Basic example">
              <button type="button" class="col-4 btn btn-accent-ligth shadow-sm" onclick="reiniciarVenta()">Reiniciar
                venta &nbsp;<i class="bi bi-arrow-counterclockwise"></i></button>
              <button type="button" class="col-4 btn btn-main-lightest shadow-sm" onclick="registrarVenta()">Registrar
                venta &nbsp;<i class="bi bi-floppy-fill"></i></button>
            </div>
          </div>
          <!-- Preview Boleta -->
          <div class="col-12 col-lg-4">
            <h2>Boleta de venta</h2>
            <div class="border-success mb-3">
              <div class="bg-main-4 p-3 rounded mb-3">
                <h5 class="text-center m-0 text-white">S/ <span class="monto-total-boleta">0.00</span></h5>
              </div>
              <div class="bg-white rounded p-4 d-flex flex-column">
                <div class="row col-12 align-self-center mb-2" th:object="${venta}">
                  <div class="col-4 ps-0">
                    <label for="input-serie" class="fw-bold">Serie</label>
                    <input type="text" id="input-serie" class="form-control-ligth rounded w-100" th:field="*{serie}"
                      readonly>
                  </div>

                  <div class="col-8 pe-0">
                    <label for="input-nro" class="fw-bold">Nro</label>
                    <input type="text" id="input-nro" class="form-control-ligth rounded w-100" th:field="*{numero}"
                      readonly>
                  </div>
                </div>
                <div class="row col-12 align-self-center mb-2">
                  <label for="input-cliente" class="fw-bold p-0">Cliente</label>
                  <input type="text" name="input-cliente" id="" class="form-control-ligth rounded w-100">
                </div>
                <div class="row col-12 align-self-center mb-2">
                  <label for="input-dni" class="fw-bold p-0">DNI</label>
                  <input type="text" name="input-dni" id="input-dni" class="form-control-ligth rounded w-100"
                    maxlength="8" pattern="[0-9]{8}" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>
                <div class="row col-12 align-self-center mb-2">
                  <label for="input-fecha-emision" class="fw-bold p-0">Fecha de Emisión</label>
                  <input type="date" name="input-fecha-emision" id="fechaEmision"
                    class="form-control-ligth rounded w-100" disabled>
                </div>
                <hr>
                <p class=""><span class="fw-bold">Subtotal:</span> S/ <span class="subtotal-boleta">0.00</span></p>
                <p class=""><span class="fw-bold">IGV: </span> S/ <span class="igv-boleta">0.00</span></p>
                <p><span class="fw-bold">Total:</span> S/ <span class="monto-total-boleta">0.00</span></p>
                <div class="row col-12 align-self-center mb-2">
                  <label for="input-efectivo" class="fw-bold p-0">Efectivo</label>
                  <input type="text" name="input-efectivo" id="input-efectivo" class="form-control-ligth rounded w-100">
                </div>
                <p><span class="fw-bold">Vuelto: </span>S/ <span id="vuelto">0.00</span></p>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>
  <!-- Modal de Confirmación -->
  <div class="modal fade" id="ventaModal" tabindex="-1" aria-labelledby="ventaModalLabel" data-bs-backdrop="static"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center">
          <i class="bi bi-bag-check-fill icon-venta-success"></i>
          <p>Venta realizada con éxito</p>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-primary mx-auto mb-5 btn-main-lightest" data-bs-dismiss="modal">XX
            comprobante</button>
          <button type="button" class="btn btn-primary mx-auto mb-5 btn-main-lightest"
            onclick="imprimirComprobante()">Imprimir
            comprobante</button>
          <p class="">* No olvide entregar productos y vuelto</p>
        </div>
      </div>
    </div>
  </div>
  <!-- <div id="comprobante" style="display: none;">
    <h3>Boleta</h3>
    <p>Serie: <span id="comp-serie"></span></p>
    <p>Número: <span id="comp-numero"></span></p>
    <p>Cliente: <span id="comp-cliente"></span></p>
    <p>IGV: S/ <span id="comp-igv"></span></p>
    <p>Total: S/ <span id="comp-total"></span></p>
    <p>Efectivo: S/ <span id="comp-efectivo"></span></p>
    <p>Vuelto: S/ <span id="comp-vuelto"></span></p>
    <hr>
    <h4>Detalles</h4>
    <table style="width:100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th>Producto</th>
          <th>Cant.</th>
          <th>Subtotal</th>
        </tr>
      </thead>
      <tbody id="comp-detalles"></tbody>
    </table>
  </div> -->
  <div id="comprobante" style="display:none; font-family: Arial; width: 80mm;">

    <!-- HEADER SUNAT -->
    <div style="text-align:center;">
      <h2 style="margin:0;">JHIRE FARMA</h2>
      <p style="margin:0;">RUC: 12345678901</p>
      <p style="margin:0;">Av. Ejemplo 123 – Lima</p>
      <p style="margin:0;">Tel: 999 999 999</p>
      <hr>
    </div>

    <!-- TIPO DE COMPROBANTE -->
    <div style="text-align:center; margin-top:5px; margin-bottom:5px;">
      <strong>BOLETA DE VENTA ELECTRÓNICA</strong><br>
      <strong><span id="comp-serie"></span>-<span id="comp-numero"></span></strong>
    </div>

    <!-- DATOS -->
    <p><strong>Fecha:</strong> <span id="comp-fecha"></span></p>
    <p><strong>Hora:</strong> <span id="comp-hora"></span></p>
    <p><strong>Cliente:</strong> <span id="comp-cliente"></span></p>

    <hr>

    <!-- DETALLES -->
    <table style="width:100%; font-size:13px;">
      <thead>
        <tr>
          <th style="text-align:left;">Descripción</th>
          <th style="text-align:center;">Cant.</th>
          <th style="text-align:right;">Importe</th>
        </tr>
      </thead>
      <tbody id="comp-detalles"></tbody>
    </table>

    <hr>

    <!-- TOTALES SUNAT -->
    <table style="width:100%; font-size:14px;">
      <tr>
        <td>IGV (18%):</td>
        <td style="text-align:right;">S/ <span id="comp-igv"></span></td>
      </tr>
      <tr>
        <td><strong>Total:</strong></td>
        <td style="text-align:right;"><strong>S/ <span id="comp-total"></span></strong></td>
      </tr>
      <tr>
        <td>Efectivo:</td>
        <td style="text-align:right;">S/ <span id="comp-efectivo"></span></td>
      </tr>
      <tr>
        <td>Vuelto:</td>
        <td style="text-align:right;">S/ <span id="comp-vuelto"></span></td>
      </tr>
    </table>

    <hr>

    <p style="text-align:center;">¡Gracias por su compra!</p>

  </div>

</body>

</html>
<script>
  //Para setear la fecha de emisión en hoy
  document.getElementById("fechaEmision").valueAsDate = new Date();

  // ============================================================
  // ===============   FUNCION: Cargar productos   ==============
  // ============================================================
  async function cargarProductos(filtro = "") {
    let url = "/api/productos";
    if (filtro) {
      url += "?buscar=" + encodeURIComponent(filtro);
    }
    const response = await fetch(url);
    const productos = await response.json();
    const tbody = document.getElementById("tabla-productos");
    tbody.innerHTML = "";
    productos.forEach(p => {
      const fila = document.createElement("tr");

      fila.innerHTML = `<tr class="text-center">
                      <td>${p.id}</td>
                      <td>${p.nombre}</td>
                      <td>${p.presentacion}</td>
                      <td>-</td>
                      <td>${p.precio}</td>
                      <td class="text-center"><button class="btn btn-accent-ligth fw-bold py-0" data-id="${p.id}"><i class="bi bi-plus"></i></button>
                      </td>
                    </tr>`;
      fila.querySelector("button").addEventListener("click", () => agregarAOrden(p));
      tbody.appendChild(fila);
    });
  }
  document.getElementById("buscador").addEventListener("input", (e) => {
    cargarProductos(e.target.value);
  });

  //Carga de productos inicial
  cargarProductos();

  //AGREGAR PRODUCTOS
  const buscador = document.getElementById("buscador");
  const tablaResultados = document.querySelector("#tablaResultados tbody");
  const tablaOrden = document.querySelector("#tablaOrden tbody");

  // ========================================================================
  // ===============   FUNCION: Agregar productos a la orden   ==============
  // ========================================================================
  let orden = [];
  function agregarAOrden(producto) {
    // Revisar si ya está en la orden
    let existente = orden.find(p => p.id === producto.id);
    if (existente) {
      existente.cantidad++;
    } else {
      orden.push({ ...producto, cantidad: 1 });
    }
    renderOrden();
  }

  // ============================================================
  // ===============   FUNCION: Mostrar orden de compra   ==============
  // ============================================================
  function renderOrden() {
    const tbody = document.querySelector("#tablaOrden tbody");
    const montoTotal = document.querySelector(".monto-total-boleta");
    tbody.innerHTML = "";
    let totalGeneral = 0;
    orden.forEach((p, index) => {
      // Para que haya una cantidad mínima y precio numérico
      if (!p.cantidad || p.cantidad < 1) p.cantidad = 1;
      p.precio = Number(p.precio) || 0;

      const totalLinea = p.precio * p.cantidad;
      totalGeneral += totalLinea;

      const fila = document.createElement("tr");
      fila.innerHTML = `
      <td>${index + 1}</td>
      <td>${p.nombre}</td>
      <td>${p.presentacion}</td>
      <td>
        <input type="number" min="1" value="${p.cantidad}" data-index="${index}" class="cantidad-input form-control-ligth rounded w-100">
      </td>
      <td>${p.precio.toFixed(2)}</td>
      <td class="total-linea">${totalLinea.toFixed(2)}</td>
      <td class="text-center">
        <button type="button" class="btn btn-danger btn-eliminar" data-index="${index}"><i class="bi bi-trash-fill"></i></button>
      </td>
    `;
      tbody.appendChild(fila);
    });

    // Agregar fila de total despues de tabla
    const filaTotal = document.createElement("tr");
    filaTotal.innerHTML = `<td colspan="6" style="text-align:right"><strong>Total:</strong></td>
                           <td><strong>${totalGeneral.toFixed(2)}</strong></td>
                           <td></td>`;
    tbody.appendChild(filaTotal);

    // Actualizar todos los elementos con clase "monto-total-boleta"
    document.querySelectorAll(".monto-total-boleta").forEach(el => {
      el.textContent = totalGeneral.toFixed(2);
    });
    //Mostrar subtotal
    document.querySelectorAll(".subtotal-boleta").forEach(el => {
      el.textContent = (totalGeneral - (totalGeneral * 0.18)).toFixed(2);
    });
    //Mostrar igv
    document.querySelectorAll(".igv-boleta").forEach(el => {
      el.textContent = (totalGeneral * 0.18).toFixed(2);
    });


    // Agregar listeners después de renderizar
    tbody.querySelectorAll(".cantidad-input").forEach(input => {
      input.addEventListener("change", (e) => {
        const idx = parseInt(e.target.dataset.index, 10);
        let val = parseInt(e.target.value, 10);
        if (isNaN(val) || val < 1) val = 1;
        orden[idx].cantidad = val;
        renderOrden();
      });
    });

    tbody.querySelectorAll(".btn-eliminar").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const idx = parseInt(e.currentTarget.dataset.index, 10);
        orden.splice(idx, 1);
        renderOrden();
      });
    });
  }

  // ============================================================
  // ===============   FUNCION: Reiniciar venta   ==============
  // ============================================================
  function reiniciarVenta() {
    // orden = [];
    // renderOrden();
    location.reload();
  }

  // ============================================================
  // ===============   FUNCION: Calcular vuelto   ==============
  // ============================================================
  function calcularVuelto() {
    const efectivoInput = document.querySelector("#input-efectivo");
    const vueltoEl = document.querySelector("#vuelto");

    // Si el input está vacío o contiene algo que no es número → limpiar vuelto
    if (efectivoInput.value.trim() === "" || isNaN(parseFloat(efectivoInput.value))) {
      vueltoEl.textContent = "0.00";
      return;
    }

    // Leer efectivo
    const efectivo = parseFloat(efectivoInput.value);

    // Leer total
    let total = 0;
    document.querySelectorAll(".monto-total-boleta").forEach(el => {
      total = parseFloat(el.textContent) || 0;
    });

    // Calcular vuelto
    const vuelto = efectivo - total;
    vueltoEl.textContent = vuelto.toFixed(2);
  }
  // Ejecutar funcion calcular vuelto
  document.querySelector("#input-efectivo").addEventListener("input", calcularVuelto);

  // ============================================================
  // ===============   FUNCION: Registrar ventas   ==============
  // ============================================================
  let ventas = [];
  async function registrarVenta() {
    if (orden.length === 0) {
      alert("El carrito está vacío.");
      return;
    }

    let fecha = document.getElementById("fechaEmision").value;
    let cliente = document.querySelector("input[name='input-cliente']").value || "SN";
    let dni = document.getElementById("input-dni").value || "00000000";
    let efectivo = parseFloat(document.getElementById("input-efectivo").value) || "0.00";
    let vuelto = document.querySelector("#vuelto").textContent;
    let igv = document.querySelector(".igv-boleta").textContent;
    let total = orden.reduce((acc, p) => acc + p.precio * p.cantidad, 0);
    let serie = document.getElementById("input-serie").value;;
    let numero = document.getElementById("input-nro").value;;

    let venta = {
      cliente: cliente,
      metodoPago: "EFECTIVO",
      dni: dni,
      efectivo: efectivo,
      vuelto: vuelto,
      igv: igv,
      total: total,
      detalles: orden.map(p => ({
        producto: { id: p.id, nombre: p.nombre },
        cantidad: p.cantidad,
        precio: p.precio,
        subtotal: p.cantidad * p.precio,
      })),
      serie: serie,
      numero: numero
    };
    fetch("/api/ventas", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(venta)
    })
      .then(res => res.text())
      .then(() => {
        let modal = new bootstrap.Modal(document.getElementById('ventaModal'));
        modal.show();;
        llenarComprobante(venta)
      });
  }
  // ============================================================
  // ===============   FUNCION: Imprimir comprobante   ==========
  // ============================================================
  function llenarComprobante(venta) {
    const fecha = new Date();
    const fechaTexto = fecha.toLocaleDateString();
    const horaTexto = fecha.toLocaleTimeString();
    // Datos
    document.querySelector("#comp-serie").textContent = venta.serie;
    document.querySelector("#comp-numero").textContent = venta.numero;
    document.querySelector("#comp-cliente").textContent = venta.cliente;
    document.querySelector("#comp-total").textContent = venta.total.toFixed(2);
    document.querySelector("#comp-igv").textContent = venta.igv;
    document.querySelector("#comp-efectivo").textContent = venta.efectivo;
    document.querySelector("#comp-vuelto").textContent = venta.vuelto;
    document.querySelector("#comp-fecha").textContent = fechaTexto;
    document.querySelector("#comp-hora").textContent = horaTexto;

    // Detalles
    const tbody = document.querySelector("#comp-detalles");
    tbody.innerHTML = "";
    venta.detalles.forEach(d => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
          <td>${d.producto.nombre}</td>
          <td>${d.cantidad}</td>
          <td>${d.subtotal.toFixed(2)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function imprimirComprobante() {
    // Mostrar div
    const comp = document.querySelector("#comprobante");
    comp.style.display = "block";

    // Ejecutar impresión
    window.print();

    // Ocultar div
    comp.style.display = "none";
    reiniciarVenta();
  }

</script>