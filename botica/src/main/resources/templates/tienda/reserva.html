<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reservar Pedido</title>

  <link rel="stylesheet" th:href="@{/css/style.css}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
    crossorigin="anonymous"></script>

  <style>
    .card {
      border: none;
      border-radius: 1rem;
    }

    .card h5 {
      font-weight: 600;
    }

    .resumen-producto img {
      border-radius: 8px;
    }

    @media (max-width: 768px) {
      .resumen-producto p {
        font-size: 0.9rem;
      }
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar bg-accent shadow-sm">
    <div class="container-fluid px-4">
      <a class="navbar-brand fw-bold" th:href="@{/}">
        <!-- <i class="bi bi-capsule text-success"></i> -->
        JhireFarma
      </a>
    </div>
  </nav>

  <!-- Contenedor principal -->
  <div class="container mt-4">

    <!-- Botón volver al carrito -->
    <a href="/carrito" class="btn btn-outline-secondary mb-3">
      <i class="bi bi-arrow-left"></i> Volver al carrito
    </a>

    <div class="row g-4">
      <!-- Columna izquierda -->
      <div class="col-lg-7">

        <!-- Card: Entrega -->
        <div class="card shadow-sm p-4 mb-4">
          <h5 class="mb-3"><i class="bi bi-geo-alt-fill text-primary me-2"></i> ¿Dónde recibirás tu pedido?</h5>

          <div class="mb-3">
            <label for="tipoEntrega" class="form-label fw-semibold">Selecciona una opción:</label>
            <select id="tipoEntrega" class="form-select" onchange="mostrarOpcionesEntrega(this.value)">
              <option value="" selected disabled>Elige una opción</option>
              <option value="direccion">En una de tus direcciones (Delivery)</option>
              <option value="botica">En una botica</option>
            </select>
          </div>

          <!-- Opción: Dirección -->
          <div id="opcionDireccion" class="d-none">
            <label for="direccion" class="form-label fw-semibold">Dirección de entrega:</label>
            <input type="text" id="direccion" name="direccion" class="form-control mb-2"
              placeholder="Ejemplo: Av. Los Pinos 123, Trujillo">
            <div class="alert alert-info py-2 small mb-0">
              <i class="bi bi-info-circle"></i>
              El costo del delivery se paga <strong>contraentrega</strong> y <strong>no está incluido</strong> en el
              total mostrado.
            </div>
          </div>

          <!-- Opción: Botica -->
          <div id="opcionBotica" class="d-none mt-3">
            <div class="p-3 bg-light rounded border">
              <h6 class="fw-bold mb-1 text-success"><i class="bi bi-shop"></i> Sede principal</h6>
              <p class="mb-0 text-secondary">Av. Cajamarca Sur</p>
              <p class="small text-muted mb-0">Horario: 8:00 AM - 10:00 PM</p>
            </div>
          </div>
        </div>

        <!-- Card: Quién recoge -->
        <div class="card shadow-sm p-4 mb-4">
          <h5><i class="bi bi-person-check text-primary me-2"></i> ¿Quién recogerá el pedido?</h5>
          <div class="form-check mt-2">
            <input class="form-check-input" type="radio" name="recoger" id="recogerYo" value="yo" checked>
            <label class="form-check-label" for="recogerYo">Yo</label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" name="recoger" id="recogerOtro" value="otro">
            <label class="form-check-label" for="recogerOtro">Otra persona</label>
          </div>
          <input type="text" id="nombreOtro" class="form-control d-none" placeholder="Nombre de otra persona">
        </div>

        <!-- Card: Horario -->
        <div class="card shadow-sm p-4 mb-4">
          <h5><i class="bi bi-clock-history text-primary me-2"></i> Horario de recojo</h5>
          <p class="mb-0 small text-muted">
            Estimamos que tu pedido estará listo desde el <strong>miércoles 30/10</strong> a las 10:00 AM.
            Te enviaremos un mensaje cuando esté disponible.
            Una vez listo, tendrás hasta el <strong>jueves 31/10</strong> para recogerlo.
            Recuerda traer tu DNI físico.
          </p>
        </div>

        <!-- Card: Pago -->
        <div class="card shadow-sm p-4 mb-4">
          <h5><i class="bi bi-cash-stack text-primary me-2"></i> Información de pago</h5>
          <p class="text-muted mb-0">Puedes pagar en efectivo o con billeteras digitales.</p>
        </div>

      </div>

      <!-- Columna derecha -->
      <div class="col-lg-5">
        <div class="card shadow-sm p-4">
          <h5 class="mb-3"><i class="bi bi-receipt text-primary me-2"></i> Resumen del pedido</h5>

          <div th:if="${#lists.isEmpty(carrito)}">
            <p class="text-muted">Tu carrito está vacío.</p>
          </div>

          <div th:each="producto : ${carrito}" class="row resumen-producto mb-3 align-items-center">
            <div class="col-3">
              <img th:src="@{${producto.imagen}}" class="img-fluid" alt="Producto">
            </div>
            <div class="col-6">
              <p class="mb-1 fw-semibold" th:text="${producto.nombre}">Nombre</p>
              <p class="mb-1 text-muted" th:text="${producto.presentacion}">Presentación</p>
              <p class="mb-0 small">Cantidad: <span th:text="${producto.cantidad}">1</span></p>
            </div>
            <div class="col-3 text-end">
              <p class="mb-0 fw-bold"
                th:text="'S/ ' + ${#numbers.formatDecimal(producto.precio * producto.cantidad, 1, 'POINT', 2, 'POINT')}">
                0.00
              </p>
            </div>
          </div>

          <hr>
          <div class="d-flex justify-content-between fw-semibold mb-2">
            <span>Total productos:</span>
            <span>S/</span>
            <span th:text="${#numbers.formatDecimal(total, 1, 'POINT', 2, 'POINT')}" id="totalTxt">0.00
            </span>
          </div>
          <p id="mensajeDelivery" class="small text-muted d-none mb-2">
            *El costo del delivery se paga <strong>contraentrega</strong> y no está incluido en el total.
          </p>

          <button class="btn btn-success w-100 mt-2" id="btnReservarAhora">
            <i class="bi bi-bag-check me-2"></i> Reservar ahora
          </button>
        </div>
      </div>
    </div>
  </div>

  <form th:action="@{/reserva/guardar}" th:object="${pedido}" method="post">
    <label>Delivery</label>
    <input type="checkbox" th:field="*{delivery}" class="" id="delivery" /> <br>
    <label>Nombre de quien recoge</label>
    <input type="text" th:field="*{nombreRecojo}" class="form-control" id="nombreRecojo" />

    <label>Horario de Recojo</label>
    <input type="time" th:field="*{horarioRecojo}" class="form-control" id="horarioRecojo" />

    <label>Lugar de Recojo</label>
    <input type="text" th:field="*{recojo}" class="form-control" id="lugarRecojo" />

    <label>Método de Pago</label>
    <select th:field="*{metodoPago}" class="form-select" id="metodoPago">
      <option value="YAPE">Yape</option>
      <option value="PLIN">Plin</option>
      <option value="EFECTIVO">Efectivo</option>
    </select>

    <label>Observaciones</label>
    <textarea th:field="*{observaciones}" class="form-control" id="observaciones"></textarea>

    <label>Total</label>
    <input type="text" th:field="*{total}" class="form-control" id="total" />
    <button class="btn btn-primary mt-3" id="btnGuardarReserva">Guardar Reserva</button>
  </form>
</body>

</html>
<!-- Script: Mostrar/ocultar opciones -->
<script>
  let tipoEntrega = document.getElementById("tipoEntrega");
  let lugarRecojo = document.getElementById("lugarRecojo");
  let dirección = document.getElementById("direccion");
  let recogerYo = document.getElementById("recogerYo");
  let recogerOtro = document.getElementById("recogerOtro");
  let nombreRecogerOtro = document.getElementById("nombreOtro");
  let nombreRecojo = document.getElementById("nombreRecojo");
  let delivery = document.getElementById("delivery");
  let total = document.getElementById("total");
  let totalTxt = document.getElementById("totalTxt");
  let btnGuardarReserva = document.getElementById("btnGuardarReserva");
  let btnReservarAhora = document.getElementById("btnReservarAhora");

  btnReservarAhora.addEventListener("click", () => {
    //Setea método de entrega y lugar de recojo
    if (tipoEntrega.value == "direccion") {
      delivery.checked = true;
      lugarRecojo.value = dirección.value;
    } else {
      delivery.checked = false;
      lugarRecojo.value = "botica";
    }
    //Setea persona para recojo
    if (recogerYo.checked == true) {
      nombreRecojo.value = "usuario"
    } else {
      nombreRecojo.value = nombreRecogerOtro.value;
    }
    //Setea total
    total.value = totalTxt.textContent;

    btnGuardarReserva.click();
  })


  function mostrarOpcionesEntrega(valor) {
    const dir = document.getElementById("opcionDireccion");
    const bot = document.getElementById("opcionBotica");
    const msg = document.getElementById("mensajeDelivery");

    dir.classList.toggle("d-none", valor !== "direccion");
    bot.classList.toggle("d-none", valor !== "botica");
    msg.classList.toggle("d-none", valor !== "direccion");
  }

  // Mostrar campo "Otra persona"
  document.getElementById("recogerOtro").addEventListener("change", () => {
    document.getElementById("nombreOtro").classList.remove("d-none");
  });
  document.getElementById("recogerYo").addEventListener("change", () => {
    document.getElementById("nombreOtro").classList.add("d-none");
  });
</script>